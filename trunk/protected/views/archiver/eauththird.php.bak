<!-- 此文件用于显示用户个人爱好相关资料 -->
<style type="text/css">
#authprocess
{
	background:#f8f8f8;
	height:26px;
	width:100%;
	border:1px solid #fefefe;
}
#authprocess ul
{
	list-style:none;
	margin:0;
	padding:5px 0 2px 0;
	height:26px;
	border:1px solid #66ffff;
}
#authprocess ul li
{
	padding:3px 30px 5px 15px;
	margin:0px;
	background:url('/public/images/separato.gif') no-repeat right;
	display:inline;
}
#authprocess ul li.active a
{
	color:black;
}

</style>

<section class="span-18 last">
<h4 class="span-14">真实资料<span class="ico ico_back"></span><a href="#archiver_authentication" class="more proedit">返回</a></h4>

<div class="form">

<?php $form=$this->beginWidget('CActiveForm', array(
	'id'=>'profile-form',
	'enableAjaxValidation'=>true,
)); ?>

<?php 

	

	$cookie = Yii::app()->getRequest()->getCookies();
	
	$filename = '/public/images/head_crop.png';
	
	$id = null;
	
//	unset($cookie['upload']);
	
	UtilHelper::dump($_COOKIE);
	
	if (isset($cookie['upload']))
	{
		$id = $cookie['upload']->value;
		
		$newModel = File::model()->findByPk($id);
		$imgPath = File::model()->generateFileName($newModel, 'avatar',false);	
		
		if (file_exists('.'.$imgPath))
		{
			$filename = $imgPath;
			$id = $newModel->id;
		}	

//		$id = $cookie['upload']->value();
		
	}



?>
	<hr class="space" />

	<div id="authprocess">
		<ul>
			<li id="eauthentication"><a href="#archiver_eauthentication" >第一步：基本资料</a></li>
			<li id="eauthsecond"><a href="#archiver_eauthsecond">第二步：学历/工作</a></li>
			<li id="eauththird"><a href="#archiver_eauththird">第三步：真实形象</a></li>
			<li id="eauthfinish"><a href="#archiver_eauthfinish">完成</a></li>
		</ul>
	</div>

	<?php echo $form->errorSummary($model); ?>
	<br />
	<hr class="space" />
	<div style="height:auto;">
		<div id="StatusBar">
		</div>
	
		<div id="Notification">
		</div>
	</div>
	<hr class="space" />
	<div class="row">
		<div class="span-13">
		<br />
		<div class="hide" id="origionalImage">
			
		</div>
		
		
		<img src="<?php echo $filename;?>" onload="this.width = this.width > 500?500:this.width;" id="target" alt="Flowers" />
		
			<input type="hidden" id="x" name="x" />
			<input type="hidden" id="y" name="y" />
			<input type="hidden" id="x2" name="x2" />
			<input type="hidden" id="y2" name="y2" />
			<input type="hidden" id="w" name="w" />
			<input type="hidden" id="h" name="h" />
			<input type="text" id="newimgx" />
			<input type="text" id="newimgy" />
			<input type="hidden" id="modelID" name="modelID" value="<?php echo $id;?>" />
		</div>
		<div class="span-4 right">
			<br />
			<div style="width:150px;height:150px;overflow:hidden;border:1px dashed #ee0000;">
				<img src="<?php echo $filename;?>" id="preview" alt="Preview" style="width:150px;" />
			</div>	
			<br />
			<input type="button" value="更换头像" class="button" style="height:30px;" onclick="checkCoords();"/>		
			<hr class="space" />
			当前头像
			<br />
			
			<div style="width:60px;height:60px;overflow:hidden;border:1px dashed #ee0000;">
				<?php echo Profile::model()->getUserAvatar(Yii::app()->user->id,array('id'=>'preview2'),60,'Preview');?>				
			</div>				
		</div>
	</div>	
	<div id="dkd"></div>
	<hr class="space" />
	<br />
	<div class="row">
		<?php 
		$this->widget('ext.uploadify.uploadifyWidget',array(
			'script'=>$this->createUrl('/archiver/upload'),
			'checkScript'=>$this->createUrl('/archiver/checkupload'),
			'onComplete'=>'js:function(event, ID, fileObj, response, data){updateImage(response);}',
			'fileExt'=>'*.jpg;',
			'auto'=>true
		));

//		$this->widget('ext.Muploadify.MUploadify',array(
//  'name'=>'myPicture',
//  'buttonText'=>Yii::t('application','Upload a picture'),
//  //'script'=>array('myController/upload','id'=>$model->id),
//  'script'=>array('/archiver/upload'),
//  //'checkScript'=>array('myController/checkUpload','id'=>$model->id),
//  //fileExt=>'*.jpg;*.png;',
//  //fileDesc=>Yii::t('application','Image files'),
//  //'uploadButton'=>true,
//  //'uploadButtonText'=>'Upload new',
//  //'uploadButtonTagname'=>'button',
//  //'uploadButtonOptions'=>array('class'=>'myButton'),
//  //'onAllComplete'=>'js:function(){alert("Pictures uploaded!";);}',
//));
		
		?>
	</div>
	<br />
	<hr class="space" />

	<div class="row clear buttons">
		<?php //echo CHtml::submitButton($model->isNewRecord ? 'Create' : 'Save',array('class'=>'button','style'=>'width:100px;height:30px;')); ?>
		<?php  
		$url = $model->isNewRecord ? 'create':'updateprofile';
		echo CHtml::ajaxSubmitButton($model->isNewRecord ? 'Create' : '下一步',CHtml::normalizeUrl(array($url,'render'=>true,'id'=>$model->id)),array('success'=>'js:function(html){addMessage(html);}'),array('class'=>'button','style'=>'width:100px;height:30px;'));
		?>
	</div>


<?php $this->endWidget(); ?>

</div><!-- form -->
<div id="loaddiv">dfsdfs</div>
</section>

<script type="text/javascript">
<!--

//检查是否选取了截图
function checkCoords()
{
	if (parseInt($('#w').val())) 
	{

		$.post('<?php echo $this->createUrl('/archiver/avatar');?>',{'rn':Math.random(),'modelID':parseInt($('#modelID').val()),'x':parseInt($('#x').val()),'y':parseInt($('#y').val()),'w':parseInt($('#w').val()),'h':parseInt($('#h').val())},function(data){

			Message(data);
			src = $('#preview').attr('src');
			
			src = src.split('.');
			
			src = src[0]+'_60.'+src[1];
			
			$('#preview2').attr('src',src);
		});
		
		return true;
	}
	
	Message('Please select a crop region then press submit.');
	return false;
};
//-->
</script>

<?php 	

    $this->widget('ext.poshytip.Poshytip', array(
    	"selector"=>".poshy",	
    	'tooltips'=>array(
			'className'=>'tip-yellowsimple',
			'showOn'=>'focus',
			'alignTo'=>'target',
			'alignX'=>'right',
			'alignY'=>'center',
			'offsetX'=>5	
    	)	
    ));
    
    $this->widget('ext.chosen.chosenWidget');
    // Initialize the extension
	$this->widget('ext.jnotify.JNotify', array(
		'statusBarId'=>'StatusBar',
		'notificationId'=>'Notification',
		'notificationHSpace'=>'30px',	
		'notificationWidth'=>'280px',
		'notificationShowAt'=>'topRight',
		//'notificationShowAt'=>'bottomLeft',
		//'notificationAppendType'=>'prepend',
	)); 
	
	$this->widget('ext.jBreadCrumb.jBreadCrumbsWidget',array(
		'id'=>'#breadCrumb3'
	));
	
	$this->widget('ext.Jcrop.JcropWidget');
	
	$regionUrl = $this->createUrl('/remote/region');
	
	$avatarUrl = $this->createUrl('/archiver/avatar');
	
	$actionid = $this->action->id;
	
	Yii::app()->clientScript->registerScript('archiver-form', "
	
//	var auto_refresh = setInterval(
//	function(){
//		$('#loaddiv').fadeOut('slow').load('{$this->createUrl('/archiver/test',array('rn'=>time()))}').fadeIn('slow');
//	},2000
//);
	function reload(url)
	{
//		$('#blankArea').css({'background':'yellow','opacity':0.2}).load(url).css({'background':'transparent','opacity':1});

		$('#blankArea').load('<?php echo $this->createUrl('/archiver/eauththird',array('rn'=>time()); ?>').hide().fadeIn(1500,function(){
			alert('ok');	
		});
	}
	
	var autolow = setInterval('reload('+location.href+')',1000);
	
	function addMessage(data)
	{
		Message(data);
	    
	    location.href='#archiver_eauthfinish';
	}
	
	function Message(data)
	{
	    $('#StatusBar').jnotifyAddMessage({
	        text: data,
	        permanent: false,
	        type: 'error',
	        showIcon: false
	    });	
	}
	
	function getCookie(cookieName) {
	  var cookieString = document.cookie;
	  var start = cookieString.indexOf(cookieName + '=');
	  // 加上等号的原因是避免在某些 Cookie 的值里有
	  // 与 cookieName 一样的字符串。
	  if (start == -1) // 找不到
	    return null;
	  start += cookieName.length + 1;
	  var end = cookieString.indexOf(';', start);
	  if (end == -1) return unescape(cookieString.substring(start));
	  return unescape(cookieString.substring(start, end));
	}
	
	
	function setCookie(cookieName,value)	
	{
		var expires = new Date();
		
		expires.setTime(expires.getTime() + 3 * 30 * 24 * 60 * 60 * 1000);

		document.cookie = cookieName + '=' + value + ';expires=' + expires.toGMTString();
		
//		alert(document.cookie);
	}
	
	
//	setCookie('upload',19);
		

		
//	alert(getCookie('upload'));

	function updateImage(response)
	{
	
	

		response = response.split('#_#');
		
		var id = response[0];
		var path = response[1];
		
		$('#modelID').val(response[0]);
		
		setCookie('upload',id);

//		alert(location.href);

		reload(location.href);
//		
//		
//		//检查目标图片尺寸
//		checkTargetSize();
//		
//		$.getJSON('{$this->createUrl('/archiver/imageinfo')}',{'id':$('#modelID').val()},function(data){
//			$('#newimgx').val(data.width);
//			$('#newimgy').val(data.height);
//			
//			width = parseInt(data.width);
//			height = parseInt(data.height);
//			
//		
//			c = 500/width;
//			 
//			
//			targetH = Math.round(c*height);
//			
//			
//			
//			$('.jcrop-holder,.jcrop-holder img').css('height',targetH);
//		});
//		
//		
//		
//		var width = Number($('#newimgx').val());
//		var height = Number($('#newimgy').val());
		
//		c = 500/width;
//		targetH = round(c*height);
		
//		alert(width + height);
		
//		alert($('#newimgx').val());
		
//		500/width = ?/height
		
		$('#target,#preview,.jcrop-holder img').attr('src',response[1]);
		
//		$('.jcrop-holder').css('height',targetH+'px'); 
			
//		alert('');
		
//		path = '/public/uploads/avatars/2012/01/25/e4ba3fe56f330df05b8d756bf5d65afc1327515560.jpg';
		


//		$('#origionalImage').html('<img alt=\"\" src=\"'+response[1]+'\" id=\"origional\" />');
//
//		alert($('#origionalImage').width());
		


//		var img = new Image();
//		img.src = response[1];
		
//		alert(img.height);
		
//		$('#origional').attr('src',response[1]);
//		
//		var img = $('#origional');
//		var newimg = new Image();
//		newimg.src = img.attr('src');
//		width = newimg.width;	///width
//		height = newimg.height;	///height	


//		width = $('#origionalImage').width();
//		
//		alert(width);
//		
//		$('#newimg').val(width);
//		
//		c = 500/width;
		
//		$('.jcrop-holder').css('height', c*height).attr(path);
		


		
		
		
//		height = $('#origionalImage').height();
//		width = $('#regionImage').width();
		
//		alert($('#regionImage').width());
//		
//		$('#target,#preview,.jcrop-holder img').attr('src ',response[1]);

//		$('#target')
//		.removeAttr('style')
//		.hide().attr('src',response[1]); 
//		$('#preview').removeAttr('style').attr('src',response[1]).find('img').css('width','150px');
//		//width: 500px; height: 500px; position: relative; background-color: black;
//		//border: medium none; margin: 0px; padding: 0px; position: absolute; width: 500px; height: 500px; opacity: 1;
//		$('.jcrop-holder')
////		.removeAttr('style')
//		.find('img')
//		.attr('src',response[1])
//		.removeAttr('style');
//		.attr('style','border: solid 1px #eee; margin: 0px; padding: 0px; position: absolute; width: 500px; opacity: 1;');
////		.css({'border':'medium none','margin':'0px','padding':'0px','position':'absolute',});
//		
//
//		
//		alert('h:'+height+'w:'+width);
//
////		alert($('jcrop-holder').find('img').attr('height'));
//		
//	
////		$('.jcrop-holder')
////		.css({});
////		.attr('style','width: 500px; position: relative;')
////		.css('height',$(this).find('img').attr('height'));
////		.css({'width':'500px','position':'relative'});
	

	}
	
	

	$('#authprocess ul>li').each(function(i){
	
//		alert($(this).attr('id'));
//		alert('{$actionid}');
		if($(this).attr('id') == '{$actionid}')
		{
//			$(this).slibings().removeClass('active');
			$(this).addClass('active');
		}
	});
	
");

?>